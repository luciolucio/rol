require 'configuration'
require 'couchrest'
require 'gmail'
require 'rake/clean'
require 'rake/testtask'
require_relative 'lib/expense'
require_relative 'lib/store'
require_relative 'lib/mailprocessortrigger'

task :default => [ :test ]

task :config do
	filename = File.expand_path( File.dirname(__FILE__) ) + '/config/config_local.rb'

	if File.exists?( filename )
		config = File.new( filename ).read
	else
		puts( "No config_local.rb found. Requesting config data." )

		print( "Enter email username: " )
		email_user = gets

		print( "Enter email password: " )
		email_passwd = gets

		print( "Enter db url (e.g. http://127.0.0.1:5984): " )
		db_url = gets

		print( "Enter db name: " )
		db_name = gets

		print( "Enter your email: " )
		email = gets

		config = File.new( "config/config_template.rb" ).read
		config = config.gsub( "<email_user>",   email_user   )
		config = config.gsub( "<email_passwd>", email_passwd )
		config = config.gsub( "<db_url>",       db_url       )
		config = config.gsub( "<db_name>",      db_name      )
		config = config.gsub( "<email>",        email        )
	end

	output_filename = File.expand_path( File.dirname(__FILE__) ) + '/config/config.rb'
	File.open( output_filename, "w" ) do | final |
		final.write( config )
	end

	Configuration.path = %w( config )
end

task :clean do
	CLEAN.add( FileList[ "*~" ] )
end

Rake::TestTask.new( :test ) do | t |
	t.pattern = 'test/*_test.rb'
end

task :installdb => [ :config ] do
	puts "Installing db"

	config = Configuration.load "config"
	db = config.db
	couch = CouchRest.new( db.url )

	puts "Creating database..."
	db = couch.database( db.name )
	db.delete! rescue nil

	db = couch.create_db( db.name )
	puts "Done creating database"

	tag_map = {
		"_id" => "Rol Tag Map",
		:type => "map",
		:tag_map => {},
	}

	description_map = {
		"_id" => "Rol Description Map",
		:type => "map",
		:description_map => {},
	}

	puts "Creating initial documents..."

	resp = db.save_doc( tag_map )
	puts "- tag map" if resp[ :ok ] == "true"

	resp = db.save_doc( description_map )
	puts "- description map" if resp[ :ok ] == "true"

	puts "Done creating initial documents"

	puts "Creating views..."
	unprocessed_triggers = {
		:map =>
"function( doc ) {
	if( doc.type == 'MailProcessorTrigger' && doc.status == 'unprocessed' )
		emit( doc.created_at, doc.expense_ids )
}",
	}

	db.save_doc( {
		"_id"   => "_design/mailprocessor",
		:views  => {
			:unprocessed_triggers => unprocessed_triggers,
		}
	} )

	puts "Done creating views"
end

task :installgmail => [ :config ] do
	puts "Creating gmail labels"

	config = Configuration.load "config"
	gmail = config.gmail
	session = Gmail.new( gmail.user, gmail.password )

	session.create_label( 'rol-unprocessed' )
	session.create_label( 'rol-processed' )
end

task :install => [ :installdb, :installgmail ] do
	puts "Installed"
end

task :samples => [ :installdb ] do
	puts "Creating samples..."

	[
		Expense.new( "VISA", "1315", Date.parse( "20130208" ), "LJ AMERICANAS", 15.8 ),
		Expense.new( "VISA", "1315", Date.parse( "20130208" ), "POLTRONAS X", 15.7 ),
	].tap do | expenses |
		expenses.each do | e |
			Store.save( e )
		end

		Store.save( MailProcessorTrigger.new( expenses.map { | e | e.id } ) )
	end

	puts "Done"
end
